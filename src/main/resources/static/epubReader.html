<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Reader</title>
  <style>
    #viewer {
      width: 100%;
      height: 90vh;
      border: 1px solid #ccc;
      position: relative;
      background: white;
    }
    #viewer iframe {
      width: 100% !important;
      height: 100% !important;
      border: none !important;
      display: block;
    }
    #controls {
      margin: 10px 0;
      text-align: center;
    }
    #controls button {
      font-size: 1rem;
      padding: 0.5em 1em;
      margin: 0 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>EPUB Reader</h1>
  <div id="top-controls" style="margin-bottom: 10px; text-align: center;">
    <a href="/"><button>Back to Library</button></a>
  </div>
  <div id="controls">
    <button id="prevBtn" aria-label="Previous Page">Prev</button>
    <button id="nextBtn" aria-label="Next Page">Next</button>
  </div>
  <div id="viewer">Loading EPUBâ€¦</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const file = params.get('file');

    if (!file) {
      document.getElementById('viewer').innerText = 'No EPUB file specified.';
    } else {
      const url = '/epub/download?file=' + encodeURIComponent(file);
      console.log('File param:', file);
      console.log('EPUB fetch URL:', url);

      const book = ePub(url, {
        openAs: "epub",
        restore: false,
        reload: false,
      });

      book.loaded.metadata.then(metadata => console.log("Metadata loaded:", metadata))
        .catch(e => console.error("Metadata load error:", e));

      book.loaded.navigation.then(nav => console.log("Navigation loaded", nav))
        .catch(e => console.error("Navigation load error:", e));

		let rendition;

		book.ready.then(() => {
		  console.log('Book ready');

		  book.opened.then(() => console.log('Book opened'))
		    .catch(e => console.error('book.opened error', e));

		  // Clear the viewer content before rendering
		  document.getElementById("viewer").innerHTML = "";

		  rendition = book.renderTo("viewer", {
		    width: "100%",
		    height: "100%",
		    flow: "scrolled"  // try scrolled for now
		  });

		  rendition.themes.select("override");

		  rendition.on("rendered", section => console.log("Rendered section:", section.href));
		  rendition.on("relocated", location => console.log("Relocated to", location));
		  rendition.on("started", () => console.log("Rendition started"));
		  rendition.on("layout", () => console.log("Layout updated"));
		  rendition.on("displayError", err => {
		    console.error("Display error:", err);
		    document.getElementById("viewer").innerText = "Failed to display EPUB.";
		  });

		  rendition.display().then(() => {
		    console.log("Rendition displayed");
		  }).catch(err => {
		    console.error("display() error:", err);
		    document.getElementById("viewer").innerText = "Failed to display EPUB.";
		  });

		  document.getElementById('prevBtn').addEventListener('click', () => rendition.prev());
		  document.getElementById('nextBtn').addEventListener('click', () => rendition.next());
		});
    }
  </script>
</body>
</html>