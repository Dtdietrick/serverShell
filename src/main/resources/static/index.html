<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Media Explorer</title>
  
  <!-- Pico theme -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@latest/css/pico.min.css">
  <!-- Basic styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/theme.css">
  <!-- Component styles -->
  <link rel="stylesheet" href="/css/components/buttons.css">
  <link rel="stylesheet" href="/css/components/pinnedLaunchers.css">
  <link rel="stylesheet" href="/css/components/mediaTree.css">
  <link rel="stylesheet" href="/css/components/viewerPlayer.css">
  <link rel="stylesheet" href="/css/components/playlist.css">
<!--  <link rel="stylesheet" href="/css/components/spinner.css">-->
  <!-- 404 fav icon -->
  <link rel="icon" href="data:,">
  <!-- Media player -->
  <script>
    // flip to disable client logging without touching the file
    window.CLIENT_LOGGING_ENABLED = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="/media/player.js"></script>
</head>
<body>
    <!-- Top nav -->
    <h2>The Stash</h2>
    <button onclick="logout()">🚪 Logout</button>
    <button onclick="window.location.href='/dashboard.html'">📊 Dashboard</button>

    <!-- Launchers/Nav -->
    <div id="pinned-launchers">
      <div id="rom-launcher">
        <h3>🎮 Choose a Game</h3>
        <ul>
          <li><button onclick="launchEmulator('Pokemon-Red.gb',this)">Pokemon Red</button></li>
          <li><button onclick="launchEmulator('Pokemon-Emerald.gba',this)">Pokemon Emerald</button></li>
		  <li><button onclick="launchEmulator('The Legend of Zelda-Ocarina of Time.z64',this)"> Ocarina of Time</button></li>
		  <li><button onclick="launchEmulator('The Legend of Zelda-Majoras Mask.z64',this)"> Majora's Mask</button></li>
        </ul>
      </div>
	  
	  <div class="media-controls">
	    <input
	      type="text"
	      id="media-search"
	      placeholder="Search..."
	    />
	    <button id="toggle-grouping" title="Toggle A–Z grouping at root"> Toggle Folder Names (A-Z)</button>
	    <button class="back-btn">Back</button>
	  </div>
	  
	  
      <div id="media-launcher">
        <h3>Browse Media</h3>
        <ul>
          <li><button onclick="firstRender('Books')" class="media-btn">📚 Books</button></li>
          <li><button onclick="firstRender('TV')" class="media-btn">📺 TV</button></li>
          <li><button onclick="firstRender('Movies')" class="media-btn">🎬 Movies</button></li>
          <li><button onclick="firstRender('Music')" class="media-btn">🎵 Music</button></li>		  
        </ul>
      </div>
	    
   <!-- Top nav end-->
   </div>

    <!-- MAIN LAYOUT -->
    <div id="main-layout">
      <aside id="tree-pane">
	    <div id="mediaTree-label" class="group-label" aria-live="polite"></div>
		<div id="mediaTree">Select A Media Type First...</div>
	  </aside>
      
      <!-- New media viewer -->
      <div class="media-viewer" id="viewer-player">
		<div id="player-header">
		  <div class="player-titlebar">
		    <h1 id="media-card">📺 Media Player</h1>
		    <!-- skip-to-end button injected here -->
		  </div>
		  <h3 id="media-title">Now Playing...</h3>
		</div>
		<div id="player-container"></div>
      </div>

    <!-- Spinner -->
    <!--    <div id="loading-spinner">⏳ Loading ...</div>-->

    <!-- Playlist Popup -->
	<div id="playlist-popup">
	  <span class="close-btn" onclick="closePlaylist()">✖</span>
	  <h3>📜 Playlist</h3>
	  <div id="playlist-media">Now Playing ...</div>

	  <input id="playlist-search" placeholder="Filter tracks…" />

	  <!-- Player docked inside the dialog -->
	  <div id="popup-player"></div>

	  <!-- Controls pinned; list scrolls below -->
	  <div id="playlist-controls">
	    <button onclick="prevInPlaylist()">⏮ Prev</button>
	    <button onclick="nextInPlaylist()">⏭ Next</button>
	    <button id="shuffle-button" onclick="shufflePlaylist()">Shuffle</button>
	  </div>

	  <!-- body wrapper gives the list a bounded region -->
	  <div id="playlist-body">
	    <ul id="playlist-items"></ul>
	  </div>
	</div>

  <!-- Main logic pulled in as ES modules -->
  <script type="module">
    // Auth (logout)
    import { logout } from '/ui/auth.js';
    window.logout = logout;

    // Virtual grouping
    import { firstRender } from '/explorer/explorer.js';

    // Emulator
    import { launchEmulator } from '/emulator/emulator.js';

    // Menu button logic
    import { attachLauncherSpinnerEvents } from '/ui/onClick.js';

    // User history media
    import { handleJumpParam } from '/media/mediaDashboard.js';

    Object.assign(window, {
      logout,
      launchEmulator,
      firstRender,
    });

    // Dashboard media
    handleJumpParam();
    window.addEventListener("DOMContentLoaded", () => {
      attachLauncherSpinnerEvents();
    });
  </script>
  
  <script type="module">
    import {
      loadPlaylist,
      closePlaylist,
      nextInPlaylist,
      prevInPlaylist,
      shufflePlaylist,
      initPlaylist,
      setPlayMediaCallback
    } from '/media/mediaPlaylist.js';

    // Expose for existing onclick handlers
    Object.assign(window, {
      loadPlaylist,
      closePlaylist,
      nextInPlaylist,
      prevInPlaylist,
      shufflePlaylist
    });

    // Hook playlist to the main player once HLS/player is ready
    // (player.js sets window.AppPlayer; it’s already loaded via <script src="/media/player.js">)
    setPlayMediaCallback((path, inPopup = true, fromPlaylist = true) => {
      return window.AppPlayer?.playMedia(path, inPopup, fromPlaylist);
    });

    // Initialize internal listeners (infinite scroll, search, etc.)
    initPlaylist();
  </script>
</body>
</html>