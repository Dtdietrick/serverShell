<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Media Explorer</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>The Stash</h2>
  <button onclick="logout()">üö™ Logout</button>
  <button id="emulator-button">üïπ Emulator</button>
  <div id="back-button">‚¨ÖÔ∏è Back</div>
  
  <input
    type="text"
    id="media-search"
    placeholder="Search..."
    style="display: none; margin: 0.5rem 1rem; padding: 0.3rem; width: 80%;"
  />

  <div id="main-layout">
    <div id="mediaTree">Loading...</div>
    <div id="player"></div>
  </div>

  <!-- Playlist popup UI -->
  <div id="playlist-popup">
    <span class="close-btn" onclick="closePlaylist()">‚úñ</span>
    <h3>üéµ Playlist</h3>
    <ul id="playlist-items"></ul>

    <div id="playlist-controls" style="margin: 1rem 0; text-align: center;">
      <button onclick="prevInPlaylist()">‚èÆ Prev</button>
      <button onclick="nextInPlaylist()">‚è≠ Next</button>
      <button id="shuffle-button" onclick="shufflePlaylist()">üîÄ Shuffle</button>
    </div>

    <div id="popup-player"></div>
  </div>

  <!-- Main logic pulled in as ES modules -->
  <script type="module">
    // Auth (logout)
    import { logout } from '/js/auth.js';
    window.logout = logout;

    // Core explorer logic
    import {
      fetchMediaTree,
      fetchAndRenderPath,
      renderFolder,
      renderVirtualGroup,
      playMedia,
      stopAllMedia,
      applyPlayerSettings
    } from '/js/mediaExplorer.js';

    // Playlist logic
    import {
      initPlaylist,
      setPlayMediaCallback,
      loadPlaylist,
      nextInPlaylist,
      prevInPlaylist,
      closePlaylist,
      shufflePlaylist
    } from '/js/playlistManager.js';

    // Expose to global for inline event handlers
    window.fetchMediaTree     = fetchMediaTree;
    window.fetchAndRenderPath = fetchAndRenderPath;
    window.renderFolder       = renderFolder;
    window.renderVirtualGroup = renderVirtualGroup;
    window.playMedia          = playMedia;
    window.stopAllMedia       = stopAllMedia;
    window.applyPlayerSettings= applyPlayerSettings;

    window.loadPlaylist       = loadPlaylist;
    window.nextInPlaylist     = nextInPlaylist;
    window.prevInPlaylist     = prevInPlaylist;
    window.closePlaylist      = closePlaylist;
    window.shufflePlaylist    = shufflePlaylist;

    // Wire up playlist ‚Üí player interaction
    setPlayMediaCallback(playMedia);
    initPlaylist();

    // Kick off initial load
    fetchMediaTree();
  </script>
  
  <!-- Emulator overlay (initially hidden) -->
  <div id="emulator-overlay" style="
       display: none;
       position: fixed;
       top: 0; left: 0;
       width: 100%; height: 100%;
       background: rgba(0,0,0,0.8);
       z-index: 9999;
       align-items: center;
       justify-content: center;
  ">
    <div style="position: relative; width: 90%; height: 90%;">
      <button id="close-emulator" style="
          position: absolute; top: 1rem; right: 1rem;
          font-size: 1.5rem; z-index: 10000;
      ">‚úñ</button>

      <!-- Empty iframe; we'll set src via JS -->
      <iframe
        id="emulator-frame"
        style="width: 100%; height: 100%; border: none;"
        allowfullscreen
      ></iframe>
    </div>
  </div>

  <script>
    const emulatorBtn = document.getElementById("emulator-button");
    const overlay     = document.getElementById("emulator-overlay");
    const closeBtn    = document.getElementById("close-emulator");
    const iframe      = document.getElementById("emulator-frame");

    const origin  = window.location.origin;                    // http://localhost:8080
    const feedUrl = `${origin}/feeds/gb-feed.json`;            // your feed
    const emuUrl = `${origin}/webrcade/play/index.html?feed=${feedUrl}`; // ‚Üê here is the emulator feed

    console.log("üïπÔ∏è Emulator URL will be:", emuUrl);

    iframe.onload  = () => console.log("‚úÖ Emulator iframe loaded");
    iframe.onerror = () => console.error("‚ùå Emulator iframe failed to load");

    emulatorBtn.addEventListener("click", () => {
      overlay.style.display = "flex";
      iframe.src = emuUrl;
    });

    closeBtn.addEventListener("click", () => {
      overlay.style.display = "none";
      iframe.src = "about:blank";
    });
  </script>
</body>
</html>