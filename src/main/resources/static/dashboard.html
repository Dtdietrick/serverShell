<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Media Explorer</title>

  <!-- Pico theme -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@latest/css/pico.min.css">
</head>
<body>

  <main class="container">
    <p style="margin-bottom: 1rem;">
      <a href="/index.html" class="contrast" role="button">Back to Media Explorer</a>
    </p>
    
	<h2>🔐 Change Password 🔐</h2>
	  <form id="password-form">
	    <label for="currentPassword">Current Password</label>
	    <input type="password" id="currentPassword" name="currentPassword" required>

	    <label for="newPassword">New Password</label>
	    <input type="password" id="newPassword" name="newPassword" required>

	    <button type="submit">⚠️ Update Password (CANNOT BE UNDONE) ⚠️</button>
	    <p id="password-message" style="margin-top: 0.5rem;"></p>
	  </form>
	  
	  <div id="admin-panel" style="display: none;"></div>
	  <script src="/util/adminDashboard.js"></script>
	  
	<h2> 📒 Recently Viewed Media 📒</h2>
   <!--  <h2>ROM Saves</h2>  -->
   <!--  <ul id="rom-saves"></ul>  -->
  </main>

  
  
  <script type="module">
  fetch('/user/dashboard')
    .then(r => r.json())
    .then(data => {
      const main = document.querySelector('main.container');
      const legacyTable = document.getElementById('recent-views'); if (legacyTable) legacyTable.remove();

      function buildTable(title, paths, tableId) {
        const section = document.createElement('section');
        const h2 = document.createElement('h2'); h2.textContent = title; section.appendChild(h2);

        if (!Array.isArray(paths) || paths.length === 0) {
          const p = document.createElement('p'); p.textContent = 'No recent items.'; section.appendChild(p);
          return section;
        }

        const table = document.createElement('table');
        table.id = tableId; table.setAttribute('role','grid'); table.className = 'striped';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="width:38ch;">📁 Media Directory</th><th>🔗 Recently Played</th></tr>';
        const tbody = document.createElement('tbody');

        paths.forEach(raw => {
          const norm = String(raw || '').replace(/\\/g, '/');
          const normNoLead = norm.replace(/^\/+/, '');      
          const segs = normNoLead.split('/');               
          const root = segs[0] || '';
          const afterRoot = segs[1] || '';

          // label
          let mediaLabel;
          switch (root) {
            case 'Music':  mediaLabel = afterRoot || '(Unknown)'; break;
            case 'TV':     mediaLabel = afterRoot || '(Unknown)';   break;
            case 'Movies': mediaLabel = afterRoot || '(Unknown)';  break;
            default:
              // fallback: parent folder name if we don’t recognize the root
              mediaLabel = segs.length > 1 ? segs[segs.length - 2] : '/';
          }

          // Item name = last segment
          const itemName = segs[segs.length - 1] || normNoLead;

          const tr = document.createElement('tr');

          const tdFolder = document.createElement('td');
          tdFolder.textContent = mediaLabel;       

          const tdItem = document.createElement('td');
          const a = document.createElement('a');
          a.href = `/index.html?jumpTo=${encodeURIComponent(norm)}`;
          a.textContent = itemName;
          tdItem.appendChild(a);

          tr.appendChild(tdFolder);
          tr.appendChild(tdItem);
          tbody.appendChild(tr);
        });

        table.appendChild(thead); table.appendChild(tbody); section.appendChild(table);
        return section;
      }

	  const music  = buildTable('🎵 Music',  data.recentMusic,  'recent-music');
	  const tv     = buildTable('📺 TV',     data.recentTV,     'recent-tv');
	  const movies = buildTable('🎬 Movies', data.recentMovies, 'recent-movies');
      
      //pin recent views under thier header                 
	  const rvHeader = Array.from(main.querySelectorAll('h2'))
	    .find(h => /recently\s*viewed\s*media/i.test(h.textContent)); 

	  //build tables	
	  const frag = document.createDocumentFragment();                           
	  [music, tv, movies].forEach(sec => frag.appendChild(sec));                 
	  rvHeader.after(frag);    
   });

         // Roms house their own save logic now

   //      const savesList = document.getElementById('rom-saves');
   //      if (data.recentRomSaves && savesList) {
   //        Object.entries(data.recentRomSaves).forEach(([rom, file]) => {
   //          const li = document.createElement('li');
   //          li.textContent = `${rom} → ${file}`;
   //          savesList.appendChild(li);
   //        });
   //      }  
   
      document.getElementById("password-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const currentPassword = document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const msg = document.getElementById("password-message");

        const res = await fetch("/user/password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ currentPassword, newPassword }),
        });

        const text = await res.text();
        msg.textContent = text;
        msg.style.color = res.ok ? "green" : "red";
      }); 
  </script>

</body>
</html>